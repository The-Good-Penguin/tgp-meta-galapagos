CVE_CHECK_MANIFEST_JSON_NAME ?= "${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.json"
CVE_CHECK_MANIFEST_JSON_PATH ?= "${IMGDEPLOYDIR}/${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.json"

python do_galapagos_upload () {
    def obtain_kernel_config():
        kernel_pkg = d.getVar('PREFERRED_PROVIDER_virtual/kernel')
        if not kernel_pkg:
            return None
        kernel_dir = d.getVar('STAGING_KERNEL_BUILDDIR')
        if not kernel_dir:
            return None
        config = os.path.join(kernel_dir, ".config")
        if not os.path.exists:
            return None

        return config

    manifest_path = d.getVar('CVE_CHECK_MANIFEST_JSON_PATH')
    manifest_name = d.getVar('CVE_CHECK_MANIFEST_JSON_NAME')
    layer_dir = d.getVar('GALAPAGOS_LAYERDIR')

    product_name = d.getVar('GALAPAGOS_PRODUCT_NAME')
    product_key = d.getVar('GALAPAGOS_PRODUCT_KEY')
    email = d.getVar('GALAPAGOS_REPORT_EMAIL')
    interval = d.getVar('GALAPAGOS_REPORT_INTERVAL')

    if product_name is None:
        bb.error("Please set GALAPAGOS_PRODUCT_NAME in your local.conf")

    if product_key is None:
        bb.error("Please set GALAPAGOS_PRODUCT_KEY in your local.conf")

    if email is None:
        bb.error("Please set GALAPAGOS_REPORT_EMAIL in your local.conf")

    if interval != "build" and interval != "daily" and interval != "weekly":
        bb.error("Please set GALAPAGOS_REPORT_INTERVAL in your local.conf to build, daily or weekly")
        return

    if product_name is None or product_key is None or email is None or interval is None:
        return

    config = obtain_kernel_config()
    if config is None:
        bb.warn("Unable to find kernel config to share with Galapagos")

    try:
        bb.plain(f"Uploading {manifest_name} {'' if config is None else 'and '+config } to Galapagos")
        bb.process.run(f"{layer_dir}/scripts/send-galapagos-yocto-cves.py {manifest_path} \"{product_name}\" \"{product_key}\" \"{email}\" \"{interval}\" { '' if config is None else config}")
    except bb.process.CmdError as exc:
        bb.warn(f"Failed to upload CVE manifest")
        return {}
}

addtask do_galapagos_upload before do_populate_lic_deploy after do_image_complete
do_galapagos_upload[network] = "1"
do_galapagos_upload[nostamp] = "1"
do_galapagos_upload[depends] += "python3-requests-native:do_populate_sysroot virtual/kernel:do_shared_workdir"
