CVE_CHECK_MANIFEST_JSON_NAME ?= "${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.json"
CVE_CHECK_MANIFEST_JSON_PATH ?= "${IMGDEPLOYDIR}/${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.json"
LAYER_INFO_JSON_NAME ?= "${IMAGE_NAME}${IMAGE_NAME_SUFFIX}-layersinfo.json"
LAYER_INFO_JSON_PATH ?= "${IMGDEPLOYDIR}/${IMAGE_NAME}${IMAGE_NAME_SUFFIX}-layersinfo.json"

python do_galapagos_layer_info () {
    import json
    import os
    import sys

    sys.path.append(d.getVar('GALAPAGOS_LAYERDIR')+"/lib")
    import gal_buildcfg

    layerinfo_name = d.getVar('LAYER_INFO_JSON_NAME')
    layerinfo_path = d.getVar('LAYER_INFO_JSON_PATH')

    layers_list = layers = (d.getVar("BBLAYERS") or "").split()
    layers_names = d.getVar('BBFILE_COLLECTIONS')

    layers_dict = {}
    layers_dict['layers'] = {}

    for layer in layers_list:
        layername=os.path.basename(layer)
        layers_dict['layers'][layername]={}

        remotes=gal_buildcfg.get_metadata_remotes(layer)

        branch=gal_buildcfg.get_metadata_branch(layer)
        revision=gal_buildcfg.get_metadata_revision(layer)
        tags=gal_buildcfg.get_metadata_describe(layer)

        remote_url = []
        for remote in remotes:
            remote_url.append(gal_buildcfg.get_metadata_remote_url(layer, remote))

        layers_dict['layers'][layername]['url']=remote_url
        layers_dict['layers'][layername]['branch']=branch
        layers_dict['layers'][layername]['revision']=revision
        if tags:
            layers_dict['layers'][layername]['tags']=tags

    with open(layerinfo_path, 'w') as f:
        json.dump(layers_dict, f, indent=4)
}

python do_galapagos_upload () {
    def obtain_kernel_config():
        kernel_pkg = d.getVar('PREFERRED_PROVIDER_virtual/kernel')
        if not kernel_pkg:
            return None
        kernel_dir = d.getVar('STAGING_KERNEL_BUILDDIR')
        if not kernel_dir:
            return None
        config = os.path.join(kernel_dir, ".config")
        if not os.path.exists:
            return None

        return config

    layerinfo_path = d.getVar('LAYER_INFO_JSON_PATH')
    manifest_path = d.getVar('CVE_CHECK_MANIFEST_JSON_PATH')
    manifest_name = d.getVar('CVE_CHECK_MANIFEST_JSON_NAME')
    layer_dir = d.getVar('GALAPAGOS_LAYERDIR')

    product_name = d.getVar('GALAPAGOS_PRODUCT_NAME')
    product_key = d.getVar('GALAPAGOS_PRODUCT_KEY')
    email = d.getVar('GALAPAGOS_REPORT_EMAIL')
    interval = d.getVar('GALAPAGOS_REPORT_INTERVAL')

    if product_name is None:
        bb.error("Please set GALAPAGOS_PRODUCT_NAME in your local.conf")

    if product_key is None:
        bb.error("Please set GALAPAGOS_PRODUCT_KEY in your local.conf")

    if email is None:
        bb.error("Please set GALAPAGOS_REPORT_EMAIL in your local.conf")

    if interval != "build" and interval != "daily" and interval != "weekly":
        bb.error("Please set GALAPAGOS_REPORT_INTERVAL in your local.conf to build, daily or weekly")
        return

    if product_name is None or product_key is None or email is None or interval is None:
        return

    config = obtain_kernel_config()
    config_args = None
    if config is None:
        bb.warn("Unable to find kernel config to share with Galapagos")
    else:
        config_args = f"--kernel_config {config} "

    layer_config = None if not os.path.isfile(layerinfo_path) else layerinfo_path
    layer_config_args = None
    if layer_config is None:
        bb.warn("Unable to find layers config to share with Galapagos")
    else:
        layer_config_args = f"--layers_config {layer_config} "

    try:
        bb.plain(f"Uploading {manifest_name} {'' if config is None else 'and '+config } {'' if layer_config is None else 'and '+layer_config } to Galapagos")
        bb.process.run(f"{layer_dir}/scripts/send-galapagos-yocto-cves.py {manifest_path} \"{product_name}\" \"{product_key}\" \"{email}\" \"{interval}\" { '' if config_args is None else config_args} {'' if layer_config_args is None else layer_config_args}")
    except bb.process.CmdError as exc:
        bb.warn(f"Failed to upload CVE manifest")
        return {}
}

addtask do_galapagos_upload before do_rm_work do_build after do_image_complete
addtask do_galapagos_layer_info before do_galapagos_upload do_rm_work do_build after do_image_complete
do_galapagos_upload[network] = "1"
do_galapagos_upload[nostamp] = "1"
do_galapagos_upload[depends] += "python3-requests-native:do_populate_sysroot virtual/kernel:do_shared_workdir"
do_galapagos_layer_info[nostamp] = "1"
do_galapagos_layer_info[depends] += "python3-requests-native:do_populate_sysroot virtual/kernel:do_shared_workdir"
