CVE_CHECK_MANIFEST_JSON_NAME ?= "${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.json"
CVE_CHECK_MANIFEST_JSON_PATH ?= "${IMGDEPLOYDIR}/${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.json"

python do_galapagos_upload () {
    manifest_path = d.getVar('CVE_CHECK_MANIFEST_JSON_PATH')
    manifest_name = d.getVar('CVE_CHECK_MANIFEST_JSON_NAME')
    layer_dir = d.getVar('GALAPAGOS_LAYERDIR')

    product_name = d.getVar('GALAPAGOS_PRODUCT_NAME')
    product_key = d.getVar('GALAPAGOS_PRODUCT_KEY')
    email = d.getVar('GALAPAGOS_REPORT_EMAIL')
    interval = d.getVar('GALAPAGOS_REPORT_INTERVAL')

    if product_name is None:
        bb.error("Please set GALAPAGOS_PRODUCT_NAME in your local.conf")

    if product_key is None:
        bb.error("Please set GALAPAGOS_PRODUCT_KEY in your local.conf")

    if email is None:
        bb.error("Please set GALAPAGOS_REPORT_EMAIL in your local.conf")

    if interval != "build" and interval != "daily" and interval != "weekly":
        bb.error("Please set GALAPAGOS_REPORT_INTERVAL in your local.conf to build, daily or weekly")
        return

    if product_name is None or product_key is None or email is None or interval is None:
        return

    try:
        bb.plain(f"Uploading {manifest_name} to Galapagos")
        bb.process.run(f"{layer_dir}/scripts/send-galapagos-yocto-cves.py {manifest_path} \"{product_name}\" \"{product_key}\" \"{email}\" \"{interval}\"")
    except bb.process.CmdError as exc:
        bb.error(f"Failed to upload CVE manifest")
        return {}
}

addtask do_galapagos_upload before do_rm_work do_build after do_image_complete
do_galapagos_upload[network] = "1"
do_galapagos_upload[nostamp] = "1"
do_galapagos_upload[depends] += "python3-requests-native:do_populate_sysroot"
